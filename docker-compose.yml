version: '3.3'
services:
    sslh:
        build: ./sslh
        ports:
            - "443:443"
        container_name: sslh
        environment:
            - HOST_LISTEN=0.0.0.0
            - PORT_LISTEN=443
            - SSH_HOST_FORWARD=dockerhost
            - SSH_PORT_FORWARD=${DCP_ENV_HOST_SSHD_PORT}
            - SSL_HOST_FORWARD=dockerhost
            - SSL_PORT_FORWARD=${DCP_ENV_NGINX_HTTPS_PORT}
        extra_hosts:
            - "dockerhost:${DCP_ENV_HOST_IP_ADDR}"
        env_file: prod.env

    traefik:
        image: traefik
        container_name: traefik
        command: --docker
        ports:
            - "80:80"
            - "443:443"
        volumes:
            - ./traefik/traefik.toml:/etc/traefik/traefik.toml
            - ./traefik/certs:/etc/ssl/certs:ro
            - /var/run/docker.sock:/var/run/docker.sock:ro
        labels:
            - "traefik.frontend.rule=Host:traefik.${DCP_ENV_DOMAIN}"
            - "traefik.port=8080"

    gitea:
        image: gitea/gitea
        container_name: gitea
        ports:
            - "22:22"
        volumes:
            - gitea-volume:/data
            - ${DCP_ENV_GITEA_CONFIG_PATH}:/data/gitea/conf/app.ini
        env_file: prod.env
        labels:
            - "traefik.frontend.rule=Host:git.${DCP_ENV_DOMAIN}"
            - "traefik.port=3000"

    keeweb:
        image: antelle/keeweb
        container_name: keeweb
        volumes:
            - ${DCP_ENV_KEEWEB_CONFIG_PATH}:/keeweb/config.json:ro
        environment:
            - VIRTUAL_HOST=keeweb.${DCP_ENV_DOMAIN}
            - VIRTUAL_PORT=443
            - VIRTUAL_PROTO=https
            - HTTPS_METHOD=${DCP_ENV_HTTPS_METHOD}
            - LETSENCRYPT_HOST=keeweb.${DCP_ENV_DOMAIN}
            - LETSENCRYPT_EMAIL=${DCP_ENV_LETSENCRYPT_EMAIL}
            - LETSENCRYPT_TEST=${DCP_ENV_LETSENCRYPT_TEST}
        env_file: prod.env

    keeweb-webdav:
        build: ./keeweb-webdav
        container_name: keeweb-webdav
        volumes:
            - ./keeweb-webdav/httpd-dav.conf:/usr/local/apache2/conf/extra/httpd-dav.conf:ro
            - ./keeweb-webdav/user.passwd:/var/local/apache2/user.passwd:ro
            - keeweb-webdav-volume:/var/www/${DCP_ENV_KEEWEB_DB_NAME}:rw
        environment:
            - VIRTUAL_HOST=webdav.keeweb.${DCP_ENV_DOMAIN}
            - HTTPS_METHOD=${DCP_ENV_HTTPS_METHOD}
            - LETSENCRYPT_HOST=webdav.keeweb.${DCP_ENV_DOMAIN}
            - LETSENCRYPT_EMAIL=${DCP_ENV_LETSENCRYPT_EMAIL}
            - LETSENCRYPT_TEST=${DCP_ENV_LETSENCRYPT_TEST}
        env_file: prod.env

    netdata:
        image: firehol/netdata
        container_name: netdata
        ports:
            - "19999:19999"
        volumes:
            - /proc:/host/proc:ro
            - /sys:/host/sys:ro
        cap_add:
            - SYS_PTRACE
        env_file: prod.env
        labels:
            - "traefik.frontend.rule=Host:netdata.${DCP_ENV_DOMAIN}"
            - "traefik.port=19999"

    piwik:
        image: piwik
        container_name: piwik
        environment:
            - VIRTUAL_HOST=piwik.${DCP_ENV_DOMAIN}
            - HTTPS_METHOD=${DCP_ENV_HTTPS_METHOD}
            - LETSENCRYPT_HOST=piwik.${DCP_ENV_DOMAIN}
            - LETSENCRYPT_EMAIL=${DCP_ENV_LETSENCRYPT_EMAIL}
            - LETSENCRYPT_TEST=${DCP_ENV_LETSENCRYPT_TEST}
        links:
            - piwik-database:db
        env_file: prod.env

    piwik-database:
        image: mysql:5
        container_name: piwik-database
        volumes:
            - piwik-database-volume:/var/lib/mysql
        environment:
            - MYSQL_ROOT_PASSWORD=${DCP_ENV_PIWIK_MYSQL_PASSWD}
        env_file: prod.env

    selfoss:
        image: jenserat/selfoss
        container_name: selfoss
        volumes:
            - /srv/selfoss:/var/www/html/data
        environment:
            - VIRTUAL_HOST=rss.${DCP_ENV_DOMAIN}
            - HTTPS_METHOD=${DCP_ENV_HTTPS_METHOD}
            - LETSENCRYPT_HOST=rss.${DCP_ENV_DOMAIN}
            - LETSENCRYPT_EMAIL=${DCP_ENV_LETSENCRYPT_EMAIL}
            - LETSENCRYPT_TEST=${DCP_ENV_LETSENCRYPT_TEST}
        env_file: prod.env

    backup:
        build: ./backup
        ports:
            - "10022:22"
        container_name: backup
        volumes:
            - ./backup/backup.sh:/etc/periodic/daily/backup:ro
            - gitea-volume:/srv/backup/gitea/:ro
            - keeweb-webdav-volume:/srv/backup/keeweb-webdav/:ro
            - piwik-database-volume:/srv/backup/piwik-database/:ro
        environment:
            - DCK_LOCAL_BACKUP_REPO=/srv/backup
            - DCK_REMOTE_BACKUP_REPO=${DCP_ENV_REMOTE_BACKUP_REPO}

volumes:
    gitea-volume:
    keeweb-webdav-volume:
    piwik-database-volume:
